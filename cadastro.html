<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - GURPS Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <style>
        /* Seu CSS existente... */
        /* Adicione apenas este novo estilo */
        .resend-container {
            text-align: center;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background: linear-gradient(145deg, var(--accent-green), #1e3a27);
            color: white;
            border: 2px solid #3a7d4f;
            padding: 10px 20px;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(145deg, #3a7d4f, #1e3a27);
            transform: translateY(-2px);
        }
        
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info-box {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--primary-gold);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .info-box i {
            color: var(--primary-gold);
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="back-home">
        <a href="index.html">
            <i class="fas fa-arrow-left"></i> Voltar √† P√°gina Inicial
        </a>
    </div>

    <div class="container">
        <div class="register-container">
            <div class="logo">
                <h1>Cadastro</h1>
                <p>Junte-se √† nossa aventura</p>
            </div>

            <!-- Caixa informativa -->
            <div class="info-box" id="infoBox" style="display: none;">
                <p><i class="fas fa-info-circle"></i> 
                    <span id="infoMessage"></span>
                </p>
            </div>

            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="fullName">
                        <i class="fas fa-user"></i> Nome Completo
                    </label>
                    <input type="text" id="fullName" class="form-input" 
                           placeholder="Seu nome de aventureiro" required>
                    <div class="error-message" id="nameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">
                        <i class="fas fa-envelope"></i> E-mail
                    </label>
                    <input type="email" id="email" class="form-input" 
                           placeholder="seu@email.com" required>
                    <div class="error-message" id="emailError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <input type="password" id="password" class="form-input" 
                           placeholder="Crie uma senha segura" required>
                    <i class="fas fa-eye input-icon" id="togglePassword"></i>
                    <div class="error-message" id="passwordError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">
                        <i class="fas fa-lock"></i> Confirmar Senha
                    </label>
                    <input type="password" id="confirmPassword" class="form-input" 
                           placeholder="Digite a senha novamente" required>
                    <div class="error-message" id="confirmPasswordError"></div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-scroll"></i> Registrar-se
                    </button>
                    <div class="loader" id="formLoader"></div>
                </div>
            </form>

            <!-- Bot√£o para reenviar confirma√ß√£o -->
            <div class="resend-container" style="display: none;" id="resendContainer">
                <button class="btn btn-secondary" id="resendBtn">
                    <i class="fas fa-paper-plane"></i> Reenviar Email de Confirma√ß√£o
                </button>
            </div>

            <div class="login-link">
                <p>J√° tem uma conta? <a href="login.html">Fa√ßa login aqui</a></p>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso no Cadastro -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-envelope-circle-check"></i>
            </div>
            <h2>Cadastro Realizado!</h2>
            <p>Enviamos um e-mail de confirma√ß√£o para <strong id="registeredEmail"></strong>.</p>
            <p><strong>Importante:</strong> Verifique sua caixa de entrada (e spam) e clique no link de confirma√ß√£o para ativar sua conta.</p>
            <p>Seu c√≥digo de jogador ser√° gerado ap√≥s a confirma√ß√£o.</p>
            <div class="player-code-display" style="font-size: 1.2rem; margin: 20px 0;">
                C√≥digo: <strong id="tempPlayerCode"></strong>
            </div>
            <p style="font-size: 0.9rem; color: var(--wood-light);">
                <i class="fas fa-exclamation-triangle"></i> Anote este c√≥digo tempor√°rio!
            </p>
            <button class="btn-close" onclick="closeSuccessModal()">Entendido</button>
        </div>
    </div>

    <!-- Modal de E-mail Confirmado -->
    <div class="modal" id="emailConfirmedModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>E-mail Confirmado!</h2>
            <p>‚úÖ Sua conta foi ativada com sucesso!</p>
            <p>Seu c√≥digo de jogador √©:</p>
            <div class="player-code-display" id="playerCodeDisplay"></div>
            <p>Guarde este c√≥digo, ele ser√° seu identificador √∫nico no sistema.</p>
            <button class="btn-close" onclick="goToLogin()">Ir para Login</button>
        </div>
    </div>

    <!-- Modal de Erro -->
    <div class="modal" id="errorModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Erro no Cadastro</h2>
            <p id="errorMessage"></p>
            <button class="btn-close" onclick="closeErrorModal()">Tentar Novamente</button>
        </div>
    </div>

    <!-- Modal de Reenvio de Email -->
    <div class="modal" id="resendModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h2>Email Reenviado!</h2>
            <p id="resendMessage"></p>
            <button class="btn-close" onclick="closeResendModal()">OK</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registerForm');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const resendBtn = document.getElementById('resendBtn');
    
    // Toggle senha vis√≠vel
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
    });
    
    // Submit form
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            await registerUser();
        }
    });
    
    // Bot√£o para reenviar confirma√ß√£o
    resendBtn.addEventListener('click', async function() {
        await resendConfirmationEmail();
    });
    
    // Verificar se email foi confirmado
    checkEmailConfirmation();
    
    // Verificar se h√° cadastro pendente
    checkPendingRegistration();
});

// =============== VALIDA√á√ÉO ===============
function validateForm() {
    const name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    let isValid = true;
    resetErrors();
    
    // Nome (m√≠nimo 3 caracteres)
    if (name.length < 3) {
        showError('nameError', 'O nome deve ter pelo menos 3 caracteres', 'fullName');
        isValid = false;
    }
    
    // Email v√°lido
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showError('emailError', 'Por favor, insira um e-mail v√°lido', 'email');
        isValid = false;
    }
    
    // Senha (m√≠nimo 6 caracteres)
    if (password.length < 6) {
        showError('passwordError', 'A senha deve ter pelo menos 6 caracteres', 'password');
        isValid = false;
    }
    
    // Confirmar senha
    if (password !== confirmPassword) {
        showError('confirmPasswordError', 'As senhas n√£o coincidem', 'confirmPassword');
        isValid = false;
    }
    
    return isValid;
}

function showError(elementId, message, inputId) {
    const errorElement = document.getElementById(elementId);
    const inputElement = document.getElementById(inputId);
    
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    inputElement.classList.add('error');
}

function resetErrors() {
    const errors = ['nameError', 'emailError', 'passwordError', 'confirmPasswordError'];
    errors.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
    
    const inputs = document.querySelectorAll('.form-input');
    inputs.forEach(input => {
        input.classList.remove('error');
    });
}

// =============== REGISTRO USANDO FUN√á√ÉO DO SUPABASE.JS ===============
async function registerUser() {
    const submitBtn = document.getElementById('submitBtn');
    const formLoader = document.getElementById('formLoader');
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    // Mostrar loading
    submitBtn.style.display = 'none';
    formLoader.style.display = 'block';
    resetErrors();
    
    try {
        console.log('üîÑ Iniciando registro para:', email);
        
        // Verificar se supabaseAuth est√° dispon√≠vel
        if (!window.supabaseAuth || !window.supabaseAuth.registerUser) {
            throw new Error('Erro: Fun√ß√£o de registro n√£o encontrada. Verifique o supabase.js');
        }
        
        // Chamar fun√ß√£o de registro do supabase.js
        const result = await window.supabaseAuth.registerUser(email, password, fullName);
        
        console.log('üìä Resultado do registro:', result);
        
        if (result.success) {
            // Mostrar modal de sucesso
            document.getElementById('registeredEmail').textContent = email;
            document.getElementById('tempPlayerCode').textContent = result.playerCode || 'Gerando...';
            document.getElementById('successModal').style.display = 'flex';
            
            // Salvar dados localmente
            localStorage.setItem('pending_registration', 'true');
            localStorage.setItem('pending_email', email);
            localStorage.setItem('pending_name', fullName);
            localStorage.setItem('pending_code', result.playerCode);
            
            // Mostrar bot√£o para reenviar confirma√ß√£o
            document.getElementById('resendContainer').style.display = 'block';
            document.getElementById('resendBtn').disabled = false;
            
            // Mostrar caixa informativa
            document.getElementById('infoBox').style.display = 'block';
            document.getElementById('infoMessage').textContent = 
                'Aguardando confirma√ß√£o do email. Verifique sua caixa de entrada e spam.';
            
            // Limpar formul√°rio
            setTimeout(() => {
                document.getElementById('registerForm').reset();
            }, 1000);
            
            console.log('‚úÖ Registro iniciado com sucesso. C√≥digo:', result.playerCode);
            
        } else {
            // Tratar erros espec√≠ficos
            let errorMessage = result.error || 'Erro desconhecido no cadastro';
            
            // Mapear erros comuns
            if (errorMessage.includes('User already registered') || 
                errorMessage.includes('already exists') ||
                errorMessage.includes('duplicate key')) {
                errorMessage = 'Este e-mail j√° est√° cadastrado. Tente fazer login ou use outro e-mail.';
                // Mostrar bot√£o de login
                document.getElementById('infoBox').style.display = 'block';
                document.getElementById('infoMessage').innerHTML = 
                    'Este email j√° est√° cadastrado. <a href="login.html" style="color: var(--primary-gold);">Clique aqui para fazer login</a>';
            } else if (errorMessage.includes('Password should')) {
                errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
            } else if (errorMessage.includes('Invalid email')) {
                errorMessage = 'Por favor, insira um e-mail v√°lido.';
            } else if (errorMessage.includes('Email rate limit exceeded')) {
                errorMessage = 'Muitas tentativas. Aguarde alguns minutos.';
            } else if (errorMessage.includes('email not confirmed')) {
                errorMessage = 'Este email ainda n√£o foi confirmado. Verifique sua caixa de entrada.';
                document.getElementById('resendContainer').style.display = 'block';
            }
            
            throw new Error(errorMessage);
        }
        
    } catch (error) {
        console.error('‚ùå Erro no cadastro:', error);
        
        // Mostrar erro no modal
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorModal').style.display = 'flex';
        
    } finally {
        // Restaurar bot√£o
        submitBtn.style.display = 'flex';
        formLoader.style.display = 'none';
    }
}

// =============== REENVIAR EMAIL DE CONFIRMA√á√ÉO ===============
async function resendConfirmationEmail() {
    const email = document.getElementById('email').value.trim() || localStorage.getItem('pending_email');
    
    if (!email) {
        alert('Por favor, digite seu email primeiro');
        return;
    }
    
    const resendBtn = document.getElementById('resendBtn');
    const originalText = resendBtn.innerHTML;
    
    try {
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        console.log('üîÑ Reenviando confirma√ß√£o para:', email);
        
        // Verificar se supabaseAuth est√° dispon√≠vel
        if (!window.supabaseAuth || !window.supabaseAuth.resendConfirmationEmail) {
            throw new Error('Fun√ß√£o de reenvio n√£o dispon√≠vel');
        }
        
        const result = await window.supabaseAuth.resendConfirmationEmail(email);
        
        if (result.success) {
            // Mostrar modal de sucesso
            document.getElementById('resendMessage').textContent = 
                `Email de confirma√ß√£o reenviado para ${email}. Verifique sua caixa de entrada e pasta de spam.`;
            document.getElementById('resendModal').style.display = 'flex';
            
            // Agendar pr√≥ximo reenvio (2 minutos)
            setTimeout(() => {
                resendBtn.disabled = false;
            }, 120000);
            
            console.log('‚úÖ Email reenviado com sucesso');
        } else {
            throw new Error(result.error || 'Erro ao reenviar email');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao reenviar email:', error);
        alert('Erro ao reenviar email: ' + error.message);
    } finally {
        resendBtn.innerHTML = originalText;
    }
}

// =============== CONFIRMA√á√ÉO DE EMAIL ===============
async function checkEmailConfirmation() {
    const urlParams = new URLSearchParams(window.location.search);
    const confirmed = urlParams.get('confirmed');
    const codeFromUrl = urlParams.get('code');
    
    console.log('üîç Verificando confirma√ß√£o:', { confirmed, codeFromUrl });
    
    if (confirmed === 'true') {
        // Email confirmado via URL
        console.log('üéâ Email confirmado via link!');
        
        // Obter c√≥digo do URL ou localStorage
        const playerCode = codeFromUrl || localStorage.getItem('pending_code');
        
        if (playerCode) {
            // Mostrar c√≥digo imediatamente
            showEmailConfirmedModal(playerCode);
            
            // Tentar completar registro no supabase
            try {
                if (window.supabaseAuth && window.supabaseAuth.checkAndCompleteRegistration) {
                    const result = await window.supabaseAuth.checkAndCompleteRegistration();
                    console.log('üìã Resultado do registro completo:', result);
                    
                    if (result.success && result.playerCode) {
                        // Atualizar c√≥digo se diferente
                        if (result.playerCode !== playerCode) {
                            document.getElementById('playerCodeDisplay').textContent = result.playerCode;
                            localStorage.setItem('player_code', result.playerCode);
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao completar registro:', error);
                // Continuar com o c√≥digo que temos
            }
            
            // Limpar dados pendentes
            localStorage.removeItem('pending_registration');
            localStorage.removeItem('pending_email');
            localStorage.removeItem('pending_name');
            localStorage.removeItem('pending_code');
            
            // Esconder bot√£o de reenvio
            document.getElementById('resendContainer').style.display = 'none';
            document.getElementById('infoBox').style.display = 'none';
        }
    } else {
        // Verificar se h√° sess√£o ativa (usu√°rio j√° confirmou)
        checkExistingSession();
    }
}

// =============== VERIFICAR SESS√ÉO EXISTENTE ===============
async function checkExistingSession() {
    try {
        if (window.supabaseAuth && window.supabaseAuth.checkAuthStatus) {
            const authStatus = await window.supabaseAuth.checkAuthStatus();
            
            if (authStatus.isAuthenticated && authStatus.emailConfirmed) {
                console.log('‚úÖ Usu√°rio j√° est√° autenticado e confirmado');
                
                // Buscar perfil do usu√°rio
                const profileResult = await window.supabaseAuth.getCurrentUserProfile();
                
                if (profileResult.success && profileResult.profile) {
                    // Mostrar c√≥digo se j√° tiver perfil
                    showEmailConfirmedModal(profileResult.profile.player_code);
                }
            }
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è Nenhuma sess√£o ativa encontrada');
    }
}

// =============== VERIFICAR CADASTRO PENDENTE ===============
function checkPendingRegistration() {
    const hasPending = localStorage.getItem('pending_registration');
    const pendingEmail = localStorage.getItem('pending_email');
    
    if (hasPending === 'true' && pendingEmail) {
        console.log('üìã Cadastro pendente encontrado para:', pendingEmail);
        
        // Preencher email no formul√°rio
        document.getElementById('email').value = pendingEmail;
        
        // Mostrar bot√£o de reenvio
        document.getElementById('resendContainer').style.display = 'block';
        
        // Mostrar caixa informativa
        document.getElementById('infoBox').style.display = 'block';
        document.getElementById('infoMessage').textContent = 
            `Aguardando confirma√ß√£o do email ${pendingEmail}. Clique no link enviado ou reenvie o email.`;
    }
}

// =============== MOSTRAR MODAL DE EMAIL CONFIRMADO ===============
function showEmailConfirmedModal(playerCode) {
    if (!playerCode) {
        // Gerar c√≥digo fallback
        playerCode = Math.floor(1000000 + Math.random() * 9000000).toString();
        console.log('‚ö†Ô∏è Usando c√≥digo fallback:', playerCode);
    }
    
    console.log('üéØ Mostrando c√≥digo confirmado:', playerCode);
    
    // Mostrar c√≥digo
    document.getElementById('playerCodeDisplay').textContent = playerCode;
    document.getElementById('emailConfirmedModal').style.display = 'flex';
    
    // Salvar dados permanentemente
    localStorage.setItem('player_code', playerCode);
    localStorage.setItem('registration_complete', 'true');
    
    // Limpar dados tempor√°rios
    localStorage.removeItem('temp_player_code');
    localStorage.removeItem('pending_registration');
    localStorage.removeItem('pending_email');
    localStorage.removeItem('pending_name');
    localStorage.removeItem('pending_code');
    
    // Obter nome do usu√°rio
    const userName = localStorage.getItem('pending_name') || 
                     document.getElementById('fullName')?.value || 
                     'Jogador';
    localStorage.setItem('user_name', userName);
    
    // Esconder elementos desnecess√°rios
    document.getElementById('resendContainer').style.display = 'none';
    document.getElementById('infoBox').style.display = 'none';
}

// =============== FUN√á√ïES MODAIS ===============
function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
}

function closeErrorModal() {
    document.getElementById('errorModal').style.display = 'none';
}

function closeResendModal() {
    document.getElementById('resendModal').style.display = 'none';
}

function goToLogin() {
    window.location.href = 'login.html?registered=true&code=' + 
                          localStorage.getItem('player_code');
}

// =============== FUN√á√ïES AUXILIARES GLOBAIS ===============
// Disponibilizar fun√ß√µes importantes globalmente
window.showEmailConfirmedModal = showEmailConfirmedModal;
window.closeSuccessModal = closeSuccessModal;
window.closeErrorModal = closeErrorModal;
window.goToLogin = goToLogin;
</script>
</body>
</html>