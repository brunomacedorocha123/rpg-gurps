<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro - GURPS Tool</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-dark: #1a1200;
      --secondary-dark: #2c2008;
      --primary-gold: #d4af37;
      --secondary-gold: #f4d03f;
      --accent-red: #8b0000;
      --accent-green: #2e5c3a;
      --text-light: #f5f5dc;
      --text-gold: #ffd700;
      --parchment: #f7f3e9;
      --wood-dark: #5d4037;
      --wood-light: #8d6e63;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'Cinzel', serif;
      background-color: var(--primary-dark);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(44, 32, 8, 0.5) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(42, 21, 11, 0.5) 0%, transparent 20%);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="none" stroke="%232c2008" stroke-width="0.5"/></svg>'),
        linear-gradient(0deg, transparent 24%, rgba(139, 0, 0, 0.05) 25%, rgba(139, 0, 0, 0.05) 26%, transparent 27%, transparent 74%, rgba(139, 0, 0, 0.05) 75%, rgba(139, 0, 0, 0.05) 76%, transparent 77%, transparent);
      background-size: 50px 50px, 10px 10px;
      opacity: 0.3;
      z-index: -1;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: linear-gradient(145deg, rgba(44, 32, 8, 0.95), rgba(26, 18, 0, 0.95));
      border: 3px solid var(--primary-gold);
      border-radius: 15px;
      padding: 40px;
      box-shadow: var(--shadow), 0 0 30px rgba(212, 175, 55, 0.2);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--accent-red), var(--primary-gold), var(--accent-green));
      z-index: 1;
    }

    h1 {
      font-family: 'Uncial Antiqua', cursive;
      text-align: center;
      color: var(--text-gold);
      margin-bottom: 10px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      color: var(--wood-light);
      font-size: 1.1rem;
    }

    .alert {
      display: none;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .alert-success {
      background: rgba(46, 92, 58, 0.9);
      color: #90ee90;
      border: 2px solid #2e5c3a;
    }

    .alert-error {
      background: rgba(139, 0, 0, 0.9);
      color: #ffb3b3;
      border: 2px solid #8b0000;
    }

    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--secondary-gold);
      font-weight: bold;
      font-size: 1.1rem;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--wood-light);
      z-index: 2;
    }

    input {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border-radius: 8px;
      border: 2px solid var(--wood-light);
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-gold);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
      background: rgba(255, 255, 255, 0.15);
    }

    input::placeholder {
      color: rgba(141, 110, 99, 0.7);
    }

    .password-rules {
      margin-top: 5px;
      font-size: 0.85rem;
      color: var(--wood-light);
      padding-left: 10px;
    }

    .btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: bold;
      background: linear-gradient(145deg, var(--primary-gold), #b8941f);
      color: var(--primary-dark);
      border: 2px solid var(--secondary-gold);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }

    .btn:hover {
      background: linear-gradient(145deg, #e6c158, #b8941f);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .link {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(141, 110, 99, 0.3);
    }

    .link p {
      color: var(--wood-light);
      margin-bottom: 10px;
    }

    .link a {
      color: var(--secondary-gold);
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .link a:hover {
      color: var(--text-gold);
      text-decoration: underline;
    }

    .id-display {
      display: none;
      background: rgba(212, 175, 55, 0.1);
      border: 2px solid var(--primary-gold);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .id-display h3 {
      color: var(--text-gold);
      margin-bottom: 10px;
      font-family: 'MedievalSharp', cursive;
    }

    .id-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--secondary-gold);
      font-family: monospace;
      letter-spacing: 3px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(141, 110, 99, 0.3);
      border-radius: 2px;
      margin-top: 20px;
      overflow: hidden;
      display: none;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-green), var(--primary-gold));
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @media (max-width: 600px) {
      .container {
        margin: 20px;
        padding: 30px 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      input {
        padding: 12px 12px 12px 40px;
      }
      
      .btn {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1><i class="fas fa-dragon"></i> GURPS TOOL</h1>
    <p class="subtitle">Junte-se √† Guilda de Aventureiros</p>

    <div class="alert" id="registerAlert"></div>

    <div class="form-group">
      <label for="username"><i class="fas fa-helmet-battle"></i> Nome do Aventureiro</label>
      <div class="input-with-icon">
        <i class="fas fa-user"></i>
        <input type="text" id="username" placeholder="Ex: Arkan, o Bravo" maxlength="50">
      </div>
    </div>

    <div class="form-group">
      <label for="email"><i class="fas fa-scroll"></i> Pergaminho de Contato</label>
      <div class="input-with-icon">
        <i class="fas fa-envelope"></i>
        <input type="email" id="email" placeholder="seu@email.com">
      </div>
    </div>

    <div class="form-group">
      <label for="password"><i class="fas fa-key"></i> Senha Secreta</label>
      <div class="input-with-icon">
        <i class="fas fa-lock"></i>
        <input type="password" id="password" placeholder="M√≠nimo 6 caracteres">
      </div>
      <div class="password-rules">
        <i class="fas fa-shield-alt"></i> Sua senha deve ter pelo menos 6 caracteres
      </div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <button class="btn" onclick="registerUser()" id="registerBtn">
      <i class="fas fa-scroll"></i> Criar Conta e Gerar ID
    </button>

    <div class="id-display" id="idDisplay">
      <h3><i class="fas fa-id-card"></i> Seu ID de Aventureiro</h3>
      <div class="id-number" id="generatedUserId">0000000</div>
      <p style="margin-top: 10px; color: var(--wood-light); font-size: 0.9rem;">
        <i class="fas fa-info-circle"></i> Guarde este n√∫mero! Ele identifica voc√™ na Guilda.
      </p>
    </div>

    <div class="link">
      <p>J√° possui uma conta na Guilda?</p>
      <a href="login.html">
        <i class="fas fa-door-open"></i> Entrar na Taverna
      </a>
    </div>
  </div>

  <script>
    // Fun√ß√£o para mostrar alerta
    function showAlert(id, message, type = 'error') {
      const el = document.getElementById(id);
      if (!el) return;

      // Se for sucesso, permite HTML
      if (type === 'success') {
        el.innerHTML = message;
      } else {
        el.textContent = message;
      }
      
      el.className = `alert alert-${type}`;
      el.style.display = 'block';

      // Auto-esconder alertas de sucesso ap√≥s 8 segundos
      if (type === 'success') {
        setTimeout(() => {
          el.style.display = 'none';
        }, 8000);
      }
    }

    // Fun√ß√£o para limpar alerta
    function clearAlert(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'none';
      el.textContent = '';
    }

    // Fun√ß√£o para atualizar barra de progresso
    function updateProgress(percent) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      
      progressBar.style.display = 'block';
      progressFill.style.width = percent + '%';
    }

    // Fun√ß√£o principal de cadastro
    async function registerUser() {
      // Limpar alertas anteriores
      clearAlert('registerAlert');
      document.getElementById('idDisplay').style.display = 'none';
      
      // Obter valores dos campos
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const registerBtn = document.getElementById('registerBtn');
      
      // Valida√ß√µes b√°sicas
      if (!username || !email || !password) {
        showAlert('registerAlert', '‚ö†Ô∏è Preencha todos os campos obrigat√≥rios.', 'error');
        return;
      }

      if (password.length < 6) {
        showAlert('registerAlert', 'üîí A senha deve ter no m√≠nimo 6 caracteres.', 'error');
        return;
      }

      if (!validateEmail(email)) {
        showAlert('registerAlert', 'üìß Por favor, insira um email v√°lido.', 'error');
        return;
      }

      // Desabilitar bot√£o durante o processo
      registerBtn.disabled = true;
      registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando sua conta...';

      try {
        // Passo 1: Iniciando cadastro
        updateProgress(25);
        showAlert('registerAlert', 'üìú Iniciando cria√ß√£o da sua conta...', 'success');
        
        // Aguarda um momento para efeito visual
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Passo 2: Criar usu√°rio no Supabase Auth
        updateProgress(50);
        showAlert('registerAlert', '‚öîÔ∏è Criando seu perfil de aventureiro...', 'success');

        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: {
              username: username,
              created_at: new Date().toISOString()
            },
            emailRedirectTo: window.location.origin + '/home.html'
          }
        });

        if (error) {
          // Tratamento de erros espec√≠ficos
          if (error.message.includes('already registered')) {
            throw new Error('üè∞ Este email j√° est√° cadastrado na Guilda. Tente fazer login.');
          } else if (error.message.includes('Invalid email')) {
            throw new Error('üìß Email inv√°lido. Verifique o formato.');
          } else if (error.message.includes('Password')) {
            throw new Error('üîí Senha muito fraca. Tente uma senha mais forte.');
          } else {
            throw error;
          }
        }

        if (!data.user) {
          throw new Error('‚ùå Falha ao criar usu√°rio. Tente novamente.');
        }

        // Passo 3: Aguardar trigger criar o perfil com ID
        updateProgress(75);
        showAlert('registerAlert', 'üé≤ Gerando seu ID exclusivo de 7 d√≠gitos...', 'success');
        
        // Aguarda para o trigger processar
        await new Promise(resolve => setTimeout(resolve, 3000));

        // Passo 4: Buscar o perfil criado pelo trigger
        updateProgress(90);
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('user_id, username')
          .eq('id', data.user.id)
          .single();

        let userId = '0000000';
        
        if (!profileError && profile) {
          userId = profile.user_id.toString().padStart(7, '0');
        } else {
          // Se n√£o encontrou perfil, tenta novamente
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          const { data: retryProfile } = await supabase
            .from('profiles')
            .select('user_id')
            .eq('id', data.user.id)
            .single();
            
          if (retryProfile) {
            userId = retryProfile.user_id.toString().padStart(7, '0');
          }
        }

        // Passo 5: Sucesso completo
        updateProgress(100);
        
        // Mostrar ID gerado
        document.getElementById('generatedUserId').textContent = userId;
        document.getElementById('idDisplay').style.display = 'block';
        
        // Mensagem de sucesso detalhada
        const successMessage = `
          <div style="text-align: left;">
            <h3 style="color: #90ee90; margin-bottom: 15px;">üéâ Conta Criada com Sucesso!</h3>
            <p><strong>üè∑Ô∏è Nome:</strong> ${username}</p>
            <p><strong>üìß Email:</strong> ${email}</p>
            <p><strong>üÜî ID de Aventureiro:</strong> <span style="color: #f4d03f; font-weight: bold;">${userId}</span></p>
            <p style="margin-top: 15px; font-size: 0.9em; color: #ccc;">
              <i class="fas fa-envelope"></i> Verifique seu email para confirmar a conta.<br>
              <i class="fas fa-clock"></i> Redirecionando em 10 segundos...
            </p>
          </div>
        `;
        
        showAlert('registerAlert', successMessage, 'success');
        
        // Redirecionar para home ap√≥s 10 segundos
        setTimeout(() => {
          window.location.href = 'home.html';
        }, 10000);

      } catch (err) {
        console.error('Erro no cadastro:', err);
        
        // Mostrar erro amig√°vel
        const errorMessage = err.message || 'Erro desconhecido ao criar conta.';
        showAlert('registerAlert', `‚ùå ${errorMessage}`, 'error');
        
        // Resetar progresso
        updateProgress(0);
      } finally {
        // Reabilitar bot√£o
        registerBtn.disabled = false;
        registerBtn.innerHTML = '<i class="fas fa-scroll"></i> Criar Conta e Gerar ID';
        
        // Esconder barra de progresso ap√≥s 3 segundos
        setTimeout(() => {
          document.getElementById('progressBar').style.display = 'none';
        }, 3000);
      }
    }

    // Fun√ß√£o para validar email
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Adicionar evento de Enter nos campos
    document.addEventListener('DOMContentLoaded', function() {
      // Permitir cadastro com Enter
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          registerUser();
        }
      });
      
      // Focar no primeiro campo
      document.getElementById('username').focus();
      
      // Efeito visual ao carregar
      setTimeout(() => {
        document.querySelector('.container').style.opacity = '1';
        document.querySelector('.container').style.transform = 'translateY(0)';
      }, 100);
    });

    // Configurar anima√ß√£o inicial do container
    window.onload = function() {
      const container = document.querySelector('.container');
      container.style.opacity = '0';
      container.style.transform = 'translateY(20px)';
      container.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    };
  </script>

</body>
</html>